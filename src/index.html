<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" href="css/bootstrap.css">
    <link rel="stylesheet" href="css/iconmoon.css">
    <link rel="stylesheet" href="css/custom.css">

    <title>Retropie arcade romset manager</title>
  </head>
  <body>

    <div class="container mt-3">
        <h1><i class="icon-pacman"></i> Retropie romset arcade manager</h1>
        <hr>

        <p>
            Easily manage your arcade roms using pre-computed CSV files.<br>
            Select a file, an action, and a target.
        </p>

        <form>

            <!-- Main CSV file -->
            <div class="input-group mb-0">
                <div class="input-group-prepend">
                    <span class="input-group-text">Main CSV file</span>
                </div>
                <input type="text" class="form-control" id="fileMainCsv">
                <div class="input-group-append">
                    <button class="btn btn-outline-primary browse" type="button" data-input="fileMainCsv">Browse</button>
                </div>
            </div>
            <p class="mt-0 mb-3">
                <small class="form-text text-muted">Select the file to execute an action with</small>
            </p>
            
            <!-- Action -->
            <div class="row">
                <div class="col-6">
                    <div class="border rounded mb-3 p-2">
                        <p class="mb-0">
                            <strong>Manage ROM files</strong>
                        </p>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="action" value="fileadd" id="fileadd" data-display=".addfiles">
                            <label class="form-check-label" for="fileadd"><i class="icon-folder-down"></i> Add listed files</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="action" value="fileremove" id="fileremove" data-display=".removefiles">
                            <label class="form-check-label" for="fileremove"><i class="icon-folder-up"></i> Remove listed files</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="action" value="filefilter" id="filefilter" data-display=".removefiles">
                            <label class="form-check-label" for="filefilter"><i class="icon-folder-minus"></i> Remove files not listed</label>
                        </div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="border rounded mb-3 p-2">
                        <p class="mb-0">
                            <strong>Manage CSV files</strong>
                        </p>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="action" value="csvadd" id="csvadd" data-display=".merge">
                            <label class="form-check-label" for="csvadd"><i class="icon-merge"></i> Add rows from another file</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="action" value="csvremove" id="csvremove" data-display=".merge">
                            <label class="form-check-label" for="csvremove"><i class="icon-split"></i> Remove rows from another file</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="action" value="csvfilter" id="csvfilter" data-display=".merge">
                            <label class="form-check-label" for="csvfilter"><i class="icon-shuffle"></i> Remove rows not listed in another file</label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Merge: secondary CSV file -->
            <div class="input-group mb-0 optional d-none merge">
                <div class="input-group-prepend">
                    <span class="input-group-text">Secondary CSV file</span>
                </div>
                <input type="text" class="form-control" id="fileSecondaryCsv">
                <div class="input-group-append">
                    <button class="btn btn-outline-secondary browse" type="button" data-input="fileSecondaryCsv">Browse</button>
                </div>
            </div>
            <p class="mt-0 mb-3 optional d-none merge">
                <small class="form-text text-muted">This file will modify the first one using the selected action.</small>
            </p>

            <!-- Merge: target output file -->
            <div class="input-group mb-0 optional d-none merge">
                <div class="input-group-prepend">
                    <span class="input-group-text">Target file</span>
                </div>
                <input type="text" class="form-control" id="fileTarget">
                <div class="input-group-append">
                    <button class="btn btn-outline-secondary browse new" type="button" data-input="fileTarget">Browse</button>
                </div>
            </div>
            <p class="mt-0 mb-3 optional d-none merge">
                <small class="form-text text-muted">The merged file to be saved</small>
            </p>
    
            <!-- Full romset location -->
            <div class="input-group mb-0 optional d-none addfiles">
                <div class="input-group-prepend">
                    <span class="input-group-text">Full romset</span>
                </div>
                <input type="text" class="form-control" id="fileRomset">
                <div class="input-group-append">
                    <button class="btn btn-outline-secondary browse folder" type="button" data-input="fileRomset">Browse</button>
                </div>
            </div>
            <p class="mt-0 mb-3 optional d-none addfiles">
                <small class="form-text text-muted">The folder containing all the files of the romset</small>
            </p>
            
            <!-- Selection romset location -->
            <div class="input-group mb-0 optional d-none addfiles removefiles">
                <div class="input-group-prepend">
                    <span class="input-group-text">Rom selection</span>
                </div>
                <input type="text" class="form-control" id="fileRomSelection">
                <div class="input-group-append">
                    <button class="btn btn-outline-secondary browse folder" type="button" data-input="fileRomSelection">Browse</button>
                </div>
            </div>
            <p class="mt-0 mb-3 optional d-none addfiles removefiles">
                <small class="form-text text-muted">The folder containing the subset of the roms you want</small>
            </p>
            
            <p class="mt-3">
                <button type="button" id="buttonOk" class="btn btn-primary btn-lg btn-block" disabled="disabled">Run</button>
            </p>

        </form>

    </div>

    <!-- Fixes jQuery integration https://stackoverflow.com/a/37480521/6776 -->
    <script>if (typeof module === 'object') {window.module = module; module = undefined;}</script>
    <script type="text/javascript" src="js/jquery.js"></script>
    <script type="text/javascript" src="js/popper.js"></script>
    <script type="text/javascript" src="js/bootstrap.js"></script>
    <script>if (window.module) module = window.module;</script>

    <script type="text/javascript">
        const {dialog} = require('electron').remote;
        const csv = require('./csv.js');
        const roms = require('./roms.js');
        const path = require('path');

        let btn = $('#buttonOk');

        // hide or display the optional fields
        $('input[name=action]').change((e) => {
            $('.optional').addClass('d-none');
            $($(e.target).data('display')).removeClass('d-none');
            btn.removeAttr('disabled');
        });

        // target file is new so default file browse cannot be used
        $('.browse').on('click', (e) => {
            let btn = $(e.target);
            let input = $('#' + btn.data('input'));

            if (btn.hasClass('folder')) {
                // selection of a folder
                dialog.showOpenDialog(
                    {
                        filters: { name: 'CSV files', extensions: [ 'csv' ] },
                        properties: ['openDirectory']
                    },
                    (folders) => {
                        if (folders &&Â folders.length !== 0) {
                            input.val(folders[0]);
                        }
                    });
            } else if (btn.hasClass('new')) {
                // create a new file
                dialog.showSaveDialog((filename) => {

                    if (typeof filename !== 'undefined' && filename !== '') {
                        if (!filename.endsWith('.csv')) { filename += '.csv'; }
                        input.val(filename);
                    }
                });
            } else {
                // select a file
                dialog.showOpenDialog(
                    {
                        filters: { name: 'CSV files', extensions: [ 'csv' ] },
                        properties: ['openFile']
                    },
                    (files) => {
                        if (files && files.length !== 0) {
                            input.val(files[0]);
                        }
                    });
            }
        });

        // Action button clicked
        btn.on('click', () => {
            // get paths from file inputs
            let main = $('#fileMainCsv').val(),
                secondary = $('#fileSecondaryCsv').val(),
                target = $('#fileTarget').val(),
                romset = $('#fileRomset').val(),
                selection = $('#fileRomSelection').val(),
                action = $('input[name=action]:checked');

            switch (action.val()) {
                case 'fileadd':
                    // check every path is filled
                    if (main === '') { window.alert('Please choose a main CSV file'); return; }
                    if (romset === '') { window.alert('Please choose the path to the full romset'); return; }
                    if (selection === '') { window.alert('Please choose the path to the selection of roms'); return; }

                    // execute action
                    roms.add(main, romset, selection);
                break;
                case 'fileremove':
                    // check every path is filled
                    if (main === '') { window.alert('Please choose a main CSV file'); return; }
                    if (selection === '') { window.alert('Please choose the path to the selection of roms'); return; }

                    // execute action
                    roms.remove(main, selection);
                break;
                case 'filefilter':
                    // check every path is filled
                    if (main === '') { window.alert('Please choose a main CSV file'); return; }
                    if (selection === '') { window.alert('Please choose the path to the selection of roms'); return; }

                    // execute action
                    roms.filter(main, selection);
                break;

                case 'csvadd':
                    // check every path is filled
                    if (main === '') { window.alert('Please choose a main CSV file'); return; }
                    if (secondary === '') { window.alert('Please choose a secondary CSV file'); return; }
                    if (target === '') { window.alert('Please choose the target CSV file'); return; }

                    // execute action
                    csv.add(main, secondary, target);
                break;
                case 'csvremove':
                    // check every path is filled
                    if (main === '') { window.alert('Please choose a main CSV file'); return; }
                    if (secondary === '') { window.alert('Please choose a secondary CSV file'); return; }
                    if (target === '') { window.alert('Please choose the target CSV file'); return; }

                    // execute action
                    csv.remove(main, secondary, target);
                break;
                case 'csvfilter':
                    // check every path is filled
                    if (main === '') { window.alert('Please choose a main CSV file'); return; }
                    if (secondary === '') { window.alert('Please choose a secondary CSV file'); return; }
                    if (target === '') { window.alert('Please choose the target CSV file'); return; }

                    // execute action
                    csv.filter(main, secondary, target);
                break;
            }

            window.alert('Done.');
        });
    </script>
</body>
</html>