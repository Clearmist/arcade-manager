<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" href="css/bootstrap.css">
    <link rel="stylesheet" href="css/iconmoon.css">
    <link rel="stylesheet" href="css/custom.css">

    <title>Retropie arcade romset manager</title>
  </head>
  <body>

    <!-- Fixes jQuery integration https://stackoverflow.com/a/37480521/6776 -->
    <script>if (typeof module === 'object') {window.module = module; module = undefined;}</script>
    <script type="text/javascript" src="js/jquery.js"></script>
    <script type="text/javascript" src="js/popper.js"></script>
    <script type="text/javascript" src="js/bootstrap.js"></script>
    <script>if (window.module) module = window.module;</script>

    <script>
        const {dialog} = require('electron').remote;
        const fs = require('fs-extra');
        const path = require('path');

        const csv = require('./csv.js');
        const roms = require('./roms.js');
        const overlays = require('./overlays.js');
        const downloader = require('./downloader.js');
    </script>

    <div class="container mt-3">
        <h1><i class="icon-pacman"></i> Retropie romset arcade manager</h1>
        <hr>

        <p>
            Easily manage your arcade roms using pre-computed CSV files.
        </p>

        <div id="content">
        </div>
    </div>

    <script type="text/javascript">
        /**
         * Bind form actions
         */
        function bindForm() {
            bindBrowse();
            bindValidate();
        }

        /**
         * Bind menu navigation
         */
        function bindNav() {
            content.find('.navmenu').on('click', (e) => {
                let link = $(e.currentTarget);
                content.load('menus/' + link.attr('href'), () => {
                    bindNav();
                    bindForm();
                });
                
                e.preventDefault();
                e.stopPropagation();
                return false;
            });
        }

        // load main menu
        const content = $('#content');
        content.load('menus/index-menu.html', bindNav);

        /**
         * Binds the click on the browse buttons
         */
        function bindBrowse() {
            // target file is new so default file browse cannot be used
            $('.browse').on('click', (e) => {
                let btn = $(e.target);
                let input = $('#' + btn.data('input'));

                if (btn.hasClass('folder')) {
                    // selection of a folder
                    dialog.showOpenDialog({ filters: { name: 'CSV files', extensions: [ 'csv' ] }, properties: ['openDirectory'] },
                        (folders) => { if (folders &&Â folders.length !== 0) { input.val(folders[0]); } });
                } else if (btn.hasClass('new')) {
                    // create a new file
                    dialog.showSaveDialog((filename) => {
                        if (typeof filename !== 'undefined' && filename !== '') {
                            if (!filename.endsWith('.csv')) { filename += '.csv'; }
                            input.val(filename);
                        }
                    });
                } else {
                    // select a file
                    dialog.showOpenDialog({ filters: { name: 'CSV files', extensions: [ 'csv' ] }, properties: ['openFile'] },
                        (files) => { if (files && files.length !== 0) { input.val(files[0]); } });
                }
            });
        }

        /**
         * Binds the validation of the form
         */
        function bindValidate() {
            let btn = $('#buttonOk');

            // Action button clicked
            btn.on('click', () => {
                // get paths from file inputs
                let main = $('#fileMainCsv').val(),
                    secondary = $('#fileSecondaryCsv').val(),
                    target = $('#fileTarget').val(),
                    romset = $('#fileRomset').val(),
                    selection = $('#fileRomSelection').val(),
                    action = btn.data('action');

                switch (action) {
                    case 'romsadd':
                        // check every path is filled
                        if (main === '') { window.alert('Please choose a main CSV file'); return; }
                        if (romset === '') { window.alert('Please choose the path to the full romset'); return; }
                        if (selection === '') { window.alert('Please choose the path to the selection of roms'); return; }

                        // execute action
                        roms.add(main, romset, selection);
                    break;
                    case 'romsdelete':
                        // check every path is filled
                        if (main === '') { window.alert('Please choose a main CSV file'); return; }
                        if (selection === '') { window.alert('Please choose the path to the selection of roms'); return; }

                        // execute action
                        roms.remove(main, selection);
                    break;
                    case 'romskeep':
                        // check every path is filled
                        if (main === '') { window.alert('Please choose a main CSV file'); return; }
                        if (selection === '') { window.alert('Please choose the path to the selection of roms'); return; }

                        // execute action
                        roms.keep(main, selection);
                    break;

                    case 'csvadd':
                        // check every path is filled
                        if (main === '') { window.alert('Please choose a main CSV file'); return; }
                        if (secondary === '') { window.alert('Please choose a secondary CSV file'); return; }
                        if (target === '') { window.alert('Please choose the target CSV file'); return; }

                        // execute action
                        csv.add(main, secondary, target);
                    break;
                    case 'csvdelete':
                        // check every path is filled
                        if (main === '') { window.alert('Please choose a main CSV file'); return; }
                        if (secondary === '') { window.alert('Please choose a secondary CSV file'); return; }
                        if (target === '') { window.alert('Please choose the target CSV file'); return; }

                        // execute action
                        csv.remove(main, secondary, target);
                    break;
                    case 'csvfilter':
                        // check every path is filled
                        if (main === '') { window.alert('Please choose a main CSV file'); return; }
                        if (secondary === '') { window.alert('Please choose a secondary CSV file'); return; }
                        if (target === '') { window.alert('Please choose the target CSV file'); return; }

                        // execute action
                        csv.keep(main, secondary, target);
                    break;
                }

                var msg = 'Done.';
                if (action === 'romsadd') {
                    msg += '\nRemember to copy BIOS and samples!';
                }

                window.alert(msg);
            });
        }
    </script>
</body>
</html>