<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" href="css/bootstrap.css">
    <link rel="stylesheet" href="css/iconmoon.css">
    <link rel="stylesheet" href="css/custom.css">

    <title>Retropie arcade romset manager</title>
  </head>
  <body>

    <!-- Fixes jQuery integration https://stackoverflow.com/a/37480521/6776 -->
    <script>if (typeof module === 'object') {window.module = module; module = undefined;}</script>
    <script type="text/javascript" src="js/jquery.js"></script>
    <script type="text/javascript" src="js/popper.js"></script>
    <script type="text/javascript" src="js/bootstrap.js"></script>
    <script>if (window.module) module = window.module;</script>

    <script>
        // require modules
        const {dialog} = require('electron').remote;
        const {shell} = require('electron');
        const fs = require('fs-extra');
        const path = require('path');
        const events = require('events');
        
        // require local modules
        const Csv = require('./csv.js');
        const Roms = require('./roms.js');
        const Overlays = require('./overlays.js');
        const Downloader = require('./downloader.js');
        
        // Instantiate local modules
        const csv = new Csv();
        const roms = new Roms();
        const overlays = new Overlays();
        const downloader = new Downloader();
    </script>

    <div class="container mt-3">
        <h1><i class="icon-pacman"></i> Retropie romset arcade manager</h1>
        <hr>
        <p>Easily manage your arcade roms using pre-computed CSV files.</p>
        <div id="content">
        </div>
    </div>

    <div class="modal" tabindex="-1" role="dialog" id="progress">
        <div class="modal-dialog modal-lg" role="document" data-backdrop="static" data-keyboard="false">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Please wait...</h5>
                </div>
                <div class="modal-body">
                    <div class="progress">
                        <div class="progress-bar" role="progressbar"></div>
                    </div>
                    <p class="text-center details"></p>
                    <p class="d-none msg"></p>
                </div>
                <div class="modal-footer d-none">
                    <button type="button" class="btn btn-outline-secondary" data-dismiss="modal">Close</button>
                  </div>
            </div>
        </div>
    </div>

    <script>
        const content = $('#content');

        /**
         * Bind menu navigation
         */
        function bindNav() {
            content.find('.navmenu').on('click', (e) => {
                let link = $(e.currentTarget);
                content.load(link.attr('href'), () => {
                    bindNav();
                    bindBrowse();
                });
                
                e.preventDefault();
                e.stopPropagation();
                return false;
            });
        }

        /**
         * Binds the click on the browse buttons
         */
        function bindBrowse() {
            // target file is new so default file browse cannot be used
            $('.browse').on('click', (e) => {
                let btn = $(e.target);
                let input = $('#' + btn.data('input'));

                if (btn.hasClass('folder')) {
                    // selection of a folder
                    dialog.showOpenDialog({ filters: { name: 'CSV files', extensions: [ 'csv' ] }, properties: ['openDirectory'] },
                        (folders) => { if (folders &&Â folders.length !== 0) { input.val(folders[0]); } });
                } else if (btn.hasClass('new')) {
                    // create a new file
                    dialog.showSaveDialog((filename) => {
                        if (typeof filename !== 'undefined' && filename !== '') {
                            if (!filename.endsWith('.csv')) { filename += '.csv'; }
                            input.val(filename);
                        }
                    });
                } else {
                    // select a file
                    dialog.showOpenDialog({ filters: { name: 'CSV files', extensions: [ 'csv' ] }, properties: ['openFile'] },
                        (files) => { if (files && files.length !== 0) { input.val(files[0]); } });
                }
            });
        }

        /**
         * Binds the modules events to the app
         */
        function bindEvents() {
            // bind rom events
            roms.on('start.add', () => { progressInit('Copying roms'); });
            roms.on('progress.add', progress);
            roms.on('end.add', () => { progressDone('Done.<br>Remember to copy BIOS and samples!'); });

            roms.on('start.remove', () => { progressInit('Deleting roms'); });
            roms.on('progress.remove', progress);
            roms.on('end.remove', () => { progressDone('Done'); });

            roms.on('start.keep', () => { progressInit('Filtering roms'); });
            roms.on('progress.keep', progress);
            roms.on('end.keep', () => { progressDone('Done'); });

            // bind csv events
            csv.on('start.add', () => { progressInit('Merging files'); });
            csv.on('progress.add', progress);
            csv.on('end.add', () => { progressDone('Done'); });

            csv.on('start.remove', () => { progressInit('Splitting files'); });
            csv.on('progress.remove', progress);
            csv.on('end.remove', () => { progressDone('Done'); });

            csv.on('start.keep', () => { progressInit('Filtering files'); });
            csv.on('progress.keep', progress);
            csv.on('end.keep', () => { progressDone('Done'); });

            // bind overlays events
            overlays.on('start.install', () => { progressInit('Installing overlays'); });
            overlays.on('progress.install', progress);
            overlays.on('end.install', () => { progressDone('Done'); });
        }

        /**
         * Shows the progression modal
         * 
         * @param {string} title The modal title
         */
         function progressInit(title) {
            let p = $('#progress');
            p.modal({ 'backdrop': 'static', 'keyboard': false });
            p.find('.modal-footer, .msg').addClass('d-none');
            p.find('.progress, .details').removeClass('d-none');
            p.find('.modal-title').html(title);
            p.find('.progress .progress-bar').width(0);
        }

        /**
         * Advances the progression modal
         * 
         * @param {int} total The total number of items
         * @param {int} current The current item number
         * @param {string} details The details to display
         */
        function progress(total, current, item) {
            let p = $('#progress');

            // set texts
            p.find('.details').text('Processing ' + item);

            // calculate current percentage
            let percent = current != 0 ? current / total * 100 : 0;
            p.find('.progress .progress-bar').width(percent + '%');
        }

        /**
         * Finishes the progression
         * 
         * @param {string} msg The message to display
         */
        function progressDone(msg) {
            let p = $('#progress');
            p.find('.modal-footer, .msg').removeClass('d-none');
            p.find('.progress, .details').addClass('d-none');
            p.find('.msg').html(msg);
        }

        /**
         * Loads main menu on app load
         */
        $(() => {
            content.load('pages/index.html', bindNav);

            bindEvents();
        });
    </script>
</body>
</html>